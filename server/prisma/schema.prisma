// DoD RIO Management Tool - Database Schema
// Legal Entity → Organizational Units (Program/Project/Department) → RIOs

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum OrgUnitType {
  program
  project
  department
}

enum RiskStatus {
  open
  mitigating
  accepted
  closed
  realized
}

enum MitigationStrategy {
  acceptance
  avoidance
  transfer
  control
  burn_down
}

model Category {
  id        String   @id @default(uuid())
  code      String   @unique  // e.g. technical, schedule
  label     String   // e.g. Technical, Schedule
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("Category")
}

model OpportunityCategory {
  id        String   @id @default(uuid())
  code      String   @unique
  label     String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("OpportunityCategory")
}

enum OpportunityStatus {
  pursue_now
  defer
  reevaluate
  reject
}

model LegalEntity {
  id          String   @id @default(uuid())
  name        String
  code        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organizationalUnits OrganizationalUnit[]
}

model OrganizationalUnit {
  id             String      @id @default(uuid())
  legalEntityId  String
  type           OrgUnitType
  name           String
  code           String
  description    String?
  parentId       String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  legalEntity   LegalEntity       @relation(fields: [legalEntityId], references: [id], onDelete: Cascade)
  parent        OrganizationalUnit? @relation("OrgUnitHierarchy", fields: [parentId], references: [id])
  children      OrganizationalUnit[] @relation("OrgUnitHierarchy")
  risks         Risk[]
  opportunities Opportunity[]
  issues        Issue[]

  @@unique([legalEntityId, type, code])
}

enum IssueStatus {
  ignore
  control
}

model Issue {
  id                   String     @id @default(uuid())
  organizationalUnitId String
  issueName            String
  description          String?
  consequence          Int        // 1-5 (likelihood fixed at 1 since it happened)
  issueLevel           String?    // low, moderate, high (from top row of 5x5)
  owner                String?
  category             String?    // Category.code (Risk Categories)
  status               IssueStatus @default(control)
  sourceRiskId         String?    // When issue was created from a realized risk
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt

  organizationalUnit OrganizationalUnit  @relation(fields: [organizationalUnitId], references: [id], onDelete: Cascade)
  sourceRisk           Risk?               @relation("IssueFromRisk", fields: [sourceRiskId], references: [id], onDelete: SetNull)
  resolutionSteps     IssueResolutionStep[]
  auditLogs           IssueAuditLog[]

  @@index([organizationalUnitId])
  @@index([sourceRiskId])
}

model IssueAuditLog {
  id         String   @id @default(uuid())
  issueId    String
  entityType String   // "issue" | "resolution_step"
  entityId   String
  action     String   // "created" | "updated" | "deleted"
  details    Json?
  createdAt  DateTime @default(now())

  issue Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@index([issueId, createdAt])
}

model IssueResolutionStep {
  id                    String    @id @default(uuid())
  issueId               String
  sequenceOrder         Int
  plannedAction         String
  estimatedStartDate    DateTime?
  estimatedEndDate      DateTime?
  expectedConsequence   Int       // 1-5 planned when step done
  expectedIssueLevel    Int       // 8, 16, 20, 23, 25 for waterfall
  actualConsequence     Int?
  actualIssueLevel      Int?
  actualCompletedAt     DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  issue Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@index([issueId])
}

model Opportunity {
  id                    String            @id @default(uuid())
  organizationalUnitId  String
  opportunityName       String
  opportunityCondition  String
  opportunityIf         String
  opportunityThen       String
  category              String?           // OpportunityCategory.code
  originalLikelihood    Int               // Immutable at creation
  originalImpact        Int               // Immutable at creation (1-5)
  likelihood            Int               // 1-5 current
  impact                Int               // 1-5 current (Very Low to Very High)
  opportunityLevel      String?           // Low, Moderate, High (1-25 mapping)
  owner                 String?
  status                OpportunityStatus @default(pursue_now)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  organizationalUnit    OrganizationalUnit     @relation(fields: [organizationalUnitId], references: [id], onDelete: Cascade)
  versions              OpportunityVersion[]
  actionPlanSteps       OpportunityActionPlanStep[]
  auditLogs             OpportunityAuditLog[]

  @@index([organizationalUnitId])
}

model OpportunityVersion {
  id                      String   @id @default(uuid())
  opportunityId           String
  version                 Int
  snapshot                Json
  likelihoodChangeReason  String?
  impactChangeReason      String?
  statusChangeRationale   String?
  createdAt               DateTime @default(now())

  opportunity Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([opportunityId, createdAt])
}

model OpportunityActionPlanStep {
  id                      String    @id @default(uuid())
  opportunityId           String
  sequenceOrder           Int
  plannedAction           String
  estimatedStartDate      DateTime?
  estimatedEndDate        DateTime?
  expectedLikelihood      Int
  expectedImpact          Int
  expectedOpportunityLevel Int
  actualLikelihood        Int?
  actualImpact            Int?
  actualOpportunityLevel  Int?
  actualCompletedAt       DateTime?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  opportunity Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  versions    OpportunityActionPlanStepVersion[]

  @@index([opportunityId])
}

model OpportunityActionPlanStepVersion {
  id               String   @id @default(uuid())
  stepId           String
  version          Int
  snapshot         Json
  createdAt        DateTime @default(now())

  step OpportunityActionPlanStep @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@index([stepId, createdAt])
}

model OpportunityAuditLog {
  id           String   @id @default(uuid())
  opportunityId String
  entityType   String   // "opportunity" | "action_plan_step"
  entityId     String
  action       String
  details      Json?
  createdAt    DateTime @default(now())

  opportunity Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([opportunityId, createdAt])
}

model Risk {
  id                    String            @id @default(uuid())
  organizationalUnitId  String
  riskName              String            // Human-readable label for lists, tooltips, reference
  riskCondition         String            // Context and root cause (DoD 2.2.3)
  riskIf                String            // The risk event that, if it occurs, has unwanted effects
  riskThen              String            // Consequences that will impact the program
  category              String?           // Category.code (user-managed list in Settings)
  originalLikelihood    Int               // Immutable: set at creation, never changed. If wrong, delete and recreate.
  originalConsequence   Int               // Immutable: set at creation, never changed. If wrong, delete and recreate.
  likelihood            Int               // 1-5: Current (editable with change reason)
  consequence           Int               // 1-5: Current (editable with change reason)
  riskLevel             String?           // Low, Moderate, High (computed)
  mitigationStrategy    MitigationStrategy?
  mitigationPlan        String?
  owner                 String?
  status                RiskStatus        @default(open)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  organizationalUnit OrganizationalUnit @relation(fields: [organizationalUnitId], references: [id], onDelete: Cascade)
  issuesCreatedFromRisk Issue[]          @relation("IssueFromRisk") // Issues created when this risk was set to Realized
  versions             RiskVersion[]
  mitigationSteps      MitigationStep[]
  auditLogs             RiskAuditLog[]
}

// Audit log: every create/update/delete on a risk or its mitigation steps (separate from History/versioning)
model RiskAuditLog {
  id         String   @id @default(uuid())
  riskId     String
  entityType String   // "risk" | "mitigation_step"
  entityId   String   // risk.id or mitigationStep.id
  action     String   // "created" | "updated" | "deleted"
  details    Json?    // e.g. { changedFields: ["riskCondition", "status"], stepNumber?: 1 }
  createdAt  DateTime @default(now())

  risk Risk @relation(fields: [riskId], references: [id], onDelete: Cascade)

  @@index([riskId, createdAt])
}

// Structured mitigation steps per risk (replaces free-form mitigation plan for tracking)
// Users enter L and C; RL (1-25) is derived and stored for waterfall plotting
model MitigationStep {
  id                      String    @id @default(uuid())
  riskId                  String
  sequenceOrder           Int       // 1, 2, 3...
  mitigationActions       String    // Clearly stated actions to reduce risk
  closureCriteria         String    // Criteria for closing this step
  estimatedStartDate      DateTime?
  estimatedEndDate        DateTime?
  expectedLikelihood      Int       // 1-5 planned posture when step done
  expectedConsequence     Int       // 1-5 planned posture when step done
  expectedRiskLevel       Int       // Derived 1-25 from L,C, stored for waterfall
  actualLikelihood        Int?      // 1-5 actual posture when step completed
  actualConsequence       Int?      // 1-5 actual posture when step completed
  actualRiskLevel         Int?      // Derived 1-25 from L,C, stored for waterfall
  actualCompletedAt       DateTime? // When step was actually completed
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  risk     Risk                    @relation(fields: [riskId], references: [id], onDelete: Cascade)
  versions MitigationStepVersion[]

  @@index([riskId])
}

model MitigationStepVersion {
  id               String   @id @default(uuid())
  mitigationStepId String
  version          Int      // 1 = create, 2+ = updates
  snapshot         Json     // Full step state for change diffing
  createdAt        DateTime @default(now())

  mitigationStep MitigationStep @relation(fields: [mitigationStepId], references: [id], onDelete: Cascade)

  @@index([mitigationStepId, createdAt])
}

// Full snapshot of risk at each change - enables version control and time-travel
model RiskVersion {
  id                      String   @id @default(uuid())
  riskId                  String
  version                 Int      // 1 = create, 2+ = updates
  snapshot                Json     // Full risk state: { riskName, riskCondition, riskIf, riskThen, category, likelihood, consequence, riskLevel, ... }
  likelihoodChangeReason  String?  // Required when likelihood changes
  consequenceChangeReason String?  // Required when consequence changes
  statusChangeRationale   String?  // Required when status changes to closed or accepted
  createdAt               DateTime @default(now())

  risk Risk @relation(fields: [riskId], references: [id], onDelete: Cascade)

  @@index([riskId, createdAt])
}
